function splitBlock(n,t,i,r){var d=this,u=[],o,y,f,e;this.diviDefaults={fbl0:800,blockSize:5e4,scaleNum:1.8};this.diviOptions=$.extend({},this.diviDefaults,i);typeof this.diviOptions.src000=="undefined"&&(this.diviOptions.src000=n+"@"+this.diviOptions.fbl0+"h_"+this.diviOptions.fbl0+"w_0e_1l.src");var p=Math.round(t.size/this.diviOptions.blockSize),a=Math.max(t.width,t.height),w=Math.min(t.width,t.height),l=Math.round(Math.log(a/this.diviOptions.fbl0)/Math.log(this.diviOptions.scaleNum));l<1&&(l=1);var v=t.width/t.height,b=Math.round(a/w),k=t.width>t.height?!0:!1,s,h,c=Math.round(Math.sqrt(p/b));for(o=l;o>=1;o--){for(u[o]=[],y=Math.ceil(100/Math.pow(1.8,l-o)),c<1&&(c=1),k?(s=c,h=s*v,h<1?h=1:1):(h=c,s=h/v,s<1?s=1:1),f=0;f<h;f++)for(u[o][f]=[],e=0;e<s;e++)wBlockPx=Math.ceil(t.width/h),hBlockPx=Math.ceil(t.height/s),u[o][f][e]={},u[o][f][e].src=n+"@"+f*wBlockPx+"-"+e*hBlockPx+"-"+wBlockPx+"-"+hBlockPx+"a_"+y+"p_100q.src",u[o][f][e].x=f*wBlockPx,u[o][f][e].y=e*hBlockPx,u[o][f][e].w=f==h-1?t.width-wBlockPx*f:wBlockPx,u[o][f][e].h=e==s-1?t.height-hBlockPx*e:hBlockPx;c=Math.round(c/this.diviOptions.scaleNum)}return u[0]=[],u[0][0]=[],u[0][0][0]={},u[0][0][0].src=this.diviOptions.src000,u[0][0][0].x=0,u[0][0][0].y=0,u[0][0][0].w=t.width,u[0][0][0].h=t.height,u[0][0][0].maxScaleTimes=l,u[0][0][0].originalURL=n,console.log(u),r&&r(u),u}(function(n,t,i){function r(r,u,f){function p(){e.options.mode="img";e.canvas=i.createElement("div");e.canvas.style.backgroundImage="url("+u[0][0][0].src+")";e.canvas.style.backgroundSize="100% 100%"}var e=this,c,l,y,a,v,w,h,o;if(e.$layer=n(r),e.imgLevels=u,e.defaults={fullWidth:u[0][0][0].w,fullHeight:u[0][0][0].h,initSize:.8,scaleNum:1.8,overScaleTimes:2,whiteBorderSize:100,thumbnail:!0,thumbnailSize:160,mode:"img"},e.canTransform="MozTransform"in i.documentElement.style||"WebkitTransform"in i.documentElement.style||"OTransform"in i.documentElement.style||"msTransform"in i.documentElement.style?!0:!1,e.options=n.extend({},e.defaults,f),e.options.mode!="img")try{e.canvas=i.createElement("canvas");e.ctx=e.canvas.getContext("2d")}catch(d){p()}else p();for(e.imgs=[],c=0;c<u.length;c++)for(e.imgs[c]=[],l=0;l<u[c].length;l++)for(e.imgs[c][l]=[],y=0;y<u[c][l].length;y++)e.imgs[c][l][y]={};c--;e.LevelMax=c;e.options.mode!="img"?(e.canvas.width=e.options.fullWidth,e.canvas.height=e.options.fullHeight):(e.canvas.style.width=e.options.fullWidth+"px",e.canvas.style.height=e.options.fullHeight+"px");e.containW=e.$layer.width();e.containH=e.$layer.height();e.kgb=e.options.fullWidth/e.options.fullHeight;containkgb=e.containW/e.containH;e.kgb>containkgb?(a=e.containW*e.options.initSize,v=a/e.kgb):(v=e.containH*e.options.initSize,a=v*e.kgb);e.top=(e.containH-v)/2;e.left=(e.containW-a)/2;e.width=a;e.height=v;e.canvas.style.position="absolute";e.canvas.style.top=0;e.canvas.style.left=0;e.$layer.css("overflow","hidden");e.$layer.css("position")=="static"&&e.$layer.css("position","relative");e.scale=1;w=Math.max(e.options.fullWidth,e.options.fullHeight);e.maxScaleNum=Math.ceil(Math.max(e.options.fullWidth/e.containW,e.options.fullHeight/e.containH)*e.options.overScaleTimes);e.curLevel=0;e.initdraw();e.$layer.append(e.canvas);e.$canvas=n(e.canvas);e.$canvas.css({"-moz-transform-origin":"0 0","-webkit-transform-origin":"0 0","-ms-transform-origin":"0 0","transform-origin":"0 0"});e.$canvas.on("mousedown touchstart",function(n){e.imgMove(n,e)});e.$layer.on("touchstart",function(n){var t=n.originalEvent.touches;if(t.length==2){n.preventDefault();var i=t[0].clientX,r=t[0].clientY,u=t[1].clientX,f=t[1].clientY,o=Math.sqrt((u-i)*(u-i)+(f-r)*(f-r));e.$layer.off("touchmove").on("touchmove",function(n){var t,s;if(n.preventDefault(),t=n.originalEvent.touches,t.length!=2){e.$layer.off("touchmove");return}i=t[0].clientX;r=t[0].clientY;u=t[1].clientX;f=t[1].clientY;s=Math.sqrt((u-i)*(u-i)+(f-r)*(f-r));s-o>2?(e.Scale(1.05),o=s):s-o<-2&&(e.Scale(.93),o=s)});e.$layer.on("touchend",function(n){n.preventDefault();e.$layer.off("touchmove touchend")})}});e.$layer.on("mousewheel DOMMouseScroll",function(n){n.preventDefault();var t=n.originalEvent.wheelDelta&&(n.originalEvent.wheelDelta>0?1:-1)||n.originalEvent.detail&&(n.originalEvent.detail>0?-1:1);typeof n.pageX!="undefined"?t>0?e.Scale(1.1,{x:n.pageX-e.$layer.offset().left,y:n.pageY-e.$layer.offset().top}):e.Scale(.9,{x:n.pageX-e.$layer.offset().left,y:n.pageY-e.$layer.offset().top}):t>0?e.Scale(1.1):e.Scale(.9)});if(e.$canvas.dblclick(function(n){n.preventDefault();typeof n.pageX!="undefined"?e.Scale(e.options.scaleNum,{x:n.pageX-e.$layer.offset().left,y:n.pageY-e.$layer.offset().top}):e.Scale(e.options.scaleNum)}),t.onorientationchange=function(){setTimeout(function(){e.resize(e)},100)},e.floorLevelTimeout="undefined",e.options.thumbnail){h='<div class="cvs_thumbnail" >';h+='<div class="huidi"><\/div>';h+='<div class="shang"><\/div>';h+='<div class="xia"><\/div>';h+='<div class="previewbox">';h+='<img src="" draggable="false" />';h+='<div class="brightbox"><\/div>';h+='<div class="dimbox top"><\/div>';h+='<div class="dimbox left"><\/div>';h+='<div class="dimbox right"><\/div>';h+='<div class="dimbox bottom"><\/div>';h+="<\/div>";h+='<span class="btn scalebrightbox"><\/span>';h+='<span class="btn closeButton">âœ•<\/span>';h+='<span class="btn smallButton">-<\/span>';h+='<span class="btn bigButton">+<\/span>';h+="<\/div>";e.$thumbnail=n(h);e.$layer.append(e.$thumbnail);e.$preview=e.$thumbnail.find(".previewbox");e.$scalebrightbox=e.$thumbnail.find(".scalebrightbox");o=e.$thumbnail.find(".brightbox");b();function b(){e.$thumbnail.css({width:e.options.thumbnailSize+"px",height:e.options.thumbnailSize+"px"});e.$thumbnail.find(".previewbox>img").attr("src",e.imgLevels[0][0][0].src);e.kgb>1?(e.$preview.h=(e.options.thumbnailSize/e.kgb).toFixed(2),e.$thumbnail.find(".previewbox").css({width:e.options.thumbnailSize+"px",height:e.$preview.h+"px"}),e.$preview.w=e.options.thumbnailSize,o.css("width",e.$preview.w+"px"),o.css("height",e.$preview.h+"px")):(e.$preview.w=(e.options.thumbnailSize*e.kgb).toFixed(2),e.$thumbnail.find(".previewbox").css({width:e.$preview.w+"px",height:e.options.thumbnailSize+"px"}),e.$preview.h=e.options.thumbnailSize,o.css("width",e.$preview.w+"px"),o.css("height",e.$preview.h+"px"));e.$scalebrightbox.mw=e.options.thumbnailSize-e.$scalebrightbox.width()-60}e.$thumbnail.find(".shang").on("mousedown touchstart",function(t){t.preventDefault();var r=e.getxy(t),u=r.x,f=r.y;n(i).off("mousemove touchmove").on("mousemove touchmove",function(n){n.preventDefault();var t=e.getxy(n),i=t.x,r=t.y,o=parseFloat(e.$thumbnail.css("right"))-i+u,s=parseFloat(e.$thumbnail.css("top"))+r-f;e.$thumbnail.css({right:o+"px",top:s+"px"});u=i;f=r});n(i).off("mouseup touchend").on("mouseup touchend",function(t){t.preventDefault();n(i).off("mousemove mouseup touchmove touchend")})});e.$thumbnail.find(".xia,.scalebrightbox").on("mousedown touchstart",function(r){e.$scalebrightbox.setCapture?e.$scalebrightbox.setCapture():t.captureEvents&&t.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);r.preventDefault();var o=e.$thumbnail.position().left,f=e.getxy(r).x,u=f-o;u<30?u=30:u>e.$scalebrightbox.mw+30&&(u=e.$scalebrightbox.mw+30);e.$scalebrightbox.css("left",u+"px");s=1+(e.maxScaleNum-1)*(u-30)/e.$scalebrightbox.mw;e.Scale(s/e.scale);n(i).off("mousemove touchmove").on("mousemove touchmove",function(n){n.preventDefault();var i=e.getxy(n).x,t=parseFloat(e.$scalebrightbox.css("left"))-30+i-f;t<0?t=0:t>e.$scalebrightbox.mw&&(t=e.$scalebrightbox.mw);e.$scalebrightbox.css("left",t+30+"px");s=1+(e.maxScaleNum-1)*t/e.$scalebrightbox.mw;e.Scale(s/e.scale);f=i});n(i).off("mouseup touchend").on("mouseup touchend",function(r){r.preventDefault();e.$scalebrightbox.releaseCapture?e.$scalebrightbox.releaseCapture():t.captureEvents&&t.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);n(i).off("mousemove mouseup touchmove touchend")})});e.$thumbnail.find(".previewbox").on("mousedown touchstart",function(r){var s=parseFloat(o[0].style.width),h=parseFloat(o[0].style.height),c=e.getxy(r),l=c.x,a=c.y,y=n(this);if(!(e.width<e.containW)||!(e.height<e.containH)){var v=y.offset(),u=l-v.left-s/2,f=a-v.top-h/2,p=u,w=f;e.left=-e.width*u/e.$preview.w;e.top=-e.height*f/e.$preview.h;u<=0?(u=0,e.left=-e.width*u/e.$preview.w+e.options.whiteBorderSize):s+u>=e.$preview.w&&(u=e.$preview.w-s,e.left=-e.width*u/e.$preview.w-e.options.whiteBorderSize);f<=0?(f=0,e.top=-e.height*f/e.$preview.h+e.options.whiteBorderSize):h+f>=e.$preview.h&&(f=e.$preview.h-h,e.top=-e.height*f/e.$preview.h-e.options.whiteBorderSize);o.css({top:f+"px",left:u+"px"});e.setCss();e.draw();n(i).off("mousemove touchmove").on("mousemove touchmove",function(n){if(n.preventDefault(),!(e.width<e.containW)||!(e.height<e.containH)){var r=e.getxy(n),u=r.x,f=r.y,t=p+u-l,i=w+f-a;t<=0?(t=-1,e.left=e.options.whiteBorderSize):s+t>=e.$preview.w?(t=e.$preview.w-s+1,e.left=-e.width+e.containW-e.options.whiteBorderSize):e.left=-e.width*t/e.$preview.w;i<=0?(i=-1,e.top=e.options.whiteBorderSize):h+i>=e.$preview.h?(i=e.$preview.h-h+1,e.top=-e.height+e.containH-e.options.whiteBorderSize):e.top=-e.height*i/e.$preview.h;o.css({top:i+"px",left:t+"px"});e.setCss();e.draw()}});n(i).off("mouseup touchend").on("mouseup touchend",function(r){r.preventDefault();o.releaseCapture?o.releaseCapture():t.captureEvents&&t.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);n(i).off("mousemove mouseup touchmove touchend")})}});e.setThumbnail=function(){function t(){var n=(e.scale-1)*e.$scalebrightbox.mw/(e.maxScaleNum-1);e.$scalebrightbox.css({left:n+30+"px"})}function i(){var i=e.containW/e.width,t;i>1&&(i=1);t=e.containH/e.height;t>1&&(t=1);n(".brightbox").css({width:e.$preview.w*i+"px",height:e.$preview.h*t+"px"})}function r(){var i=parseFloat(o[0].style.width),r=parseFloat(o[0].style.height),n=-e.$preview.w*e.left/e.width,t=-e.$preview.h*e.top/e.height;n<=0?n=0:i+n>=e.$preview.w&&(n=e.$preview.w-i);t<=0?t=0:r+t>=e.$preview.h&&(t=e.$preview.h-r);o.css({left:n+"px",top:t+"px"});k()}t();i();r()};function k(){var t=parseFloat(o[0].style.width),i=parseFloat(o[0].style.height),u=parseFloat(o.css("left"))+t+"px",n=o.css("top"),f=e.$preview.w-(parseFloat(o.css("left"))+t)+"px",r=o[0].style.height,s=o.css("left"),h=parseFloat(o.css("top"))+i+"px",c=e.$preview.h-(parseFloat(o.css("top"))+i)+"px";e.$thumbnail.find(".dimbox.top").css({left:0,top:0,width:"100%",height:n});e.$thumbnail.find(".dimbox.left").css({left:0,top:n,width:s,height:r});e.$thumbnail.find(".dimbox.right").css({left:u,top:n,width:f,height:r});e.$thumbnail.find(".dimbox.bottom").css({left:0,top:h,width:"100%",height:c})}n(".bigButton").click(function(){e.Scale(e.options.scaleNum)});n(".smallButton").click(function(){e.Scale(1/e.options.scaleNum)});n(".closeButton").click(function(){e.destroy()})}e.setCss()}n.fn.cvszoom=function(n,t){return new r(this,n,t)};r.prototype.initdraw=function(){for(var t,i=this,n=0;n<i.imgLevels[0].length;n++)for(t=0;t<i.imgLevels[0][n].length;t++)(function(n,t){i.imgload(0,n,t)})(n,t)};r.prototype.imgload=function(n,t,i){var r=this;typeof r.imgs[n][t][i].complete=="undefined"?(r.imgs[n][t][i]=new Image,r.imgs[n][t][i].isdrawed=!1,r.imgs[n][t][i].onload=function(){r.options.mode!="img"?n==r.curLevel&&this.isdrawed==!1&&(r.ctx.drawImage(this,r.imgLevels[n][t][i].x,r.imgLevels[n][t][i].y,r.imgLevels[n][t][i].w,r.imgLevels[n][t][i].h),this.isdrawed=!0):(this.style.position="absolute",this.style.width=r.imgLevels[n][t][i].w+"px",this.style.height=r.imgLevels[n][t][i].h+"px",this.style.top=r.imgLevels[n][t][i].y+"px",this.style.left=r.imgLevels[n][t][i].x+"px",this.style.zIndex=n,r.canvas.appendChild(this))},r.imgs[n][t][i].src=r.imgLevels[n][t][i].src):r.imgs[n][t][i].complete==!0&&r.options.mode!="img"&&r.imgs[n][t][i].onload()};r.prototype.setCss=function(){function i(n,t){n.css("transform",t);n.css("-ms-transform",t);n.css("-webkit-transform",t);n.css("-moz-transform",t)}var n=this,t;n.width<n.containW?(t=n.containW-n.width,n.left<0?n.left=0:n.left>t?n.left=t:1):(t=n.width-n.containW+n.options.whiteBorderSize,n.left>n.options.whiteBorderSize?n.left=n.options.whiteBorderSize:n.left<-t?n.left=-t:1);n.height<n.containH?(t=n.containH-n.height,n.top<0?n.top=0:n.top>t?n.top=t:1):(t=n.height-n.containH+n.options.whiteBorderSize,n.top>n.options.whiteBorderSize?n.top=n.options.whiteBorderSize:n.top<-t?n.top=-t:1);n.canTransform?i(n.$canvas,"matrix("+n.width/n.options.fullWidth+",0,0,"+n.height/n.options.fullHeight+","+n.left+","+n.top+")"):(n.canvas.style.width=n.width+"px",n.canvas.style.height=n.height+"px",n.canvas.style.top=n.top+"px",n.canvas.style.left=n.left+"px");n.options.thumbnail&&n.setThumbnail()};r.prototype.Scale=function(n,t){var i=this,u,r;i.scale*n>i.maxScaleNum?n=i.maxScaleNum/i.scale:i.scale*n<1?n=1/i.scale:1;u=t||{x:i.containW/2,y:i.containH/2};i.left=u.x-i.width*n*(u.x-i.left)/i.width;i.top=u.y-i.height*n*(u.y-i.top)/i.height;i.width=i.width*n;i.height=i.height*n;i.scale=i.scale*n;i.setCss();r=Math.ceil(Math.log(i.scale)/Math.log(i.options.scaleNum));r>i.LevelMax?r=i.LevelMax:r<0&&(r=0);i.floorLevelTimeout!="undefined"&&(clearTimeout(i.floorLevelTimeout),i.floorLevelTimeout="undefined");i.floorLevelTimeout=setTimeout(function(){i.draw(r)},300)};r.prototype.rectTest=function(n,t){return n.x<t.x+t.w&&n.x+n.w>t.x&&n.y<t.y+t.h&&n.y+n.h>t.y};r.prototype.draw=function(n){var t=this,u,f,i,r;if(n&&n!=t.curLevel)for(i=0;i<t.imgLevels[n].length;i++)for(r=0;r<t.imgLevels[n][i].length;r++)t.imgs[n][i][r].isdrawed=!1;for(u=t.options.fullWidth/t.width,f=t.curLevel=n||t.curLevel,i=0;i<t.imgLevels[f].length;i++)for(r=0;r<t.imgLevels[f][i].length;r++)t.rectTest(t.imgLevels[f][i][r],{x:-t.left*u,y:-t.top*u,w:t.containW*u,h:t.containH*u})&&t.imgload(f,i,r)};r.prototype.imgMove=function(r,u){var o;if(r.preventDefault(),o="undefined",this.setCapture?this.setCapture():t.captureEvents&&t.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP),o!="undefined"&&(clearInterval(o),o="undefined"),typeof r.originalEvent.touches!="undefined"&&r.originalEvent.touches.length>1){n(i).off("touchmove touchend");return}var l=u.getxy(r),f=l.x,e=l.y,a=f,v=e,s=f,h=e,c=(new Date).getTime();n(i).on("mousemove touchmove",function(n){n.preventDefault();var t=u.getxy(n),i=t.x,r=t.y;u.left=u.left+i-f;u.top=u.top+r-e;u.setCss();u.draw();f=i;e=r});n(i).on("mouseup touchend",function(r){var a,l;if(r.preventDefault(),a=(new Date).getTime(),l=Math.abs(Math.round(Math.sqrt((f-s)*(f-s)+(e-h)*(e-h))))/(a-c),l>2){vx=(f-s)/(a-c);vy=(e-h)/(a-c);l=l/2;vx=vx/2;vy=vy/2;var p=0,w=10,v=l/w;ax=Math.sqrt(v*v*vx*vx/l/l);ay=Math.sqrt(v*v*vy*vy/l/l);o=setInterval(function(){p++;p>=w&&(clearInterval(o),u.draw());x=vx*40;y=vy*40;vx>0?vx-=ax*.04:vx+=ax*.04;vy>0?vy-=ay*.04:vy+=ax*.04;u.left+=x;u.top+=y;u.setCss()},40)}u.$layer.releaseCapture?u.$layer.releaseCapture():t.captureEvents&&t.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);n(i).off("mousemove mouseup touchmove touchend");flag=!1})};r.prototype.resize=function(n){if(n.options.mode=="img"){var i=n.$layer.width(),r=n.$layer.height(),t=n.containW/i;n.width=n.width*t;n.height=n.height*t;n.left=n.left+(i-n.containW)/2-(n.width-n.width/t)/2;n.top=n.top+(r-n.containH)/2-(n.height-n.height/t)/2;n.containW=i;n.containH=r;n.setCss();n.draw()}};r.prototype.destroy=function(){var n=this;n.$layer.off("mousedown touchstart mousewheel DOMMouseScroll");n.$canvas.remove();n.options.thumbnail&&n.$thumbnail.remove();n.closed();delete n};r.prototype.closed=function(){console.log("closed")};r.prototype.getxy=function(n){if(typeof n.originalEvent!="undefined"&&(n=n.originalEvent),typeof n.targetTouches!="undefined")return{x:n.targetTouches[0].clientX,y:n.targetTouches[0].clientY};if(typeof n.targetTouches=="undefined"){if(typeof n.clientX!="undefined")return{x:n.clientX,y:n.clientY};if(typeof n.pageX!="undefined")return{x:n.pageX,y:n.pageY}}}})(jQuery,window,document);